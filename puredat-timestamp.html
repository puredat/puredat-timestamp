<link rel="import" href="../polymer/polymer.html">
<script src="../moment/moment.js"></script>

<!--
`puredat-timestamp`


@demo demo/index.html 
-->

<dom-module id="puredat-timestamp">

  <template>
    <style>
      :host[readonly] paper-icon-button{
        display: none;
      }
      .buttons{
        background-color: white;
      }
    </style>

    <paper-input
        style="padding: 5px"
        id="input"
        label="[[label]]"
        pattern="[[pattern]]"
        allowed-pattern="[[allowedPattern]]"
        value="{{displayValue}}"
        prevent-invalid-input
        error-message="{{errorMessage}}"
        invalid$="[[hasErrors]]"
        disabled$="[[disabled]]"
        auto-validate
        always-float-label
        type="string"
        minlength="[[minlength]]"
        maxlength="[[maxlength]]"
        placeholder="[[placeholder]]"
        required$="[[required]]"
        readonly$="[[readonly]]"
        store-date-format="[[storeDateFormat]]"
        display-date-format="[[displayDateFormat]]"
        store-timezone="[[storeTimezone]]"
        display-timezone="[[displayTimezone]]">
      <paper-icon-button suffix icon="event" on-click="calendarClickHandler"></paper-icon-button>
    </paper-input>

    <paper-dialog id="dialog" on-iron-overlay-closed="closeDialogHandler">
      <paper-date-picker
          style="margin: 0; padding: 0"
          id="datePicker"
          locale="[[locale]]"
          responsive-width="655px">
      </paper-date-picker>
      <paper-time-picker
          style="margin: 0; padding: 0"
          id="timePicker">
      </paper-time-picker>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm>OK</paper-button>
      </div>
    </paper-dialog>
  </template>

  <script>
    TimestampElement = Polymer({
      is: "puredat-timestamp",

      properties: {
        value: {
          type: String,
          notify: true,
          observer: '_valueChanged'
        },

        displayValue: {
          type: String
        },

        label: {
          type: String
        },

        locale: {
          type: String,
          value: "es"
        },

        errorMessage: String,

        disabled: Boolean,

        required: Boolean,

        hasErrors: Boolean,

        placeholder: String,

        readonly: {
          type: Boolean,
          reflectToAttribute: true,
          value: false,
        },

        minlength: {
          type: Number,
          value: 19
        },

        maxlength: {
          type: Number,
          value: 26
        },

        allowedPattern: {
          type: String,
          value: "[0-9-:\. \+]"
        },

        pattern: {
          type: String,
          value: "^$|[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}(\.[0-9]{3})(\\+[0-9]{2})*"
        },

        storeDateFormat: {
          type: String,
          value: "YYYY-MM-DD HH:mm:ss.SSSZZ"
        },

        displayDateFormat: {
          type: String,
          value: "DD/MM/YYYY HH:mm:ss.SSSZZ"
        },

        storeTimezone: {
          type: String,
          value: "+00:00"
        },

        displayTimezone: {
          type: String,
          value: "+01:00"
        }
      },

      calendarClickHandler: function(event) {
        if (this.value != null && this.value != "") {
          var reg = /(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2}).*/;
          var dateArray = reg.exec(this.value);
          if (dateArray.length >= 4) {
            var currentTimezone = moment(new Date()).utcOffset();
            var dateObject = new Date(+dateArray[1], +dateArray[2] - 1, +dateArray[3], dateArray[4], dateArray[5], 0, 0);
            this.$.datePicker.date = moment(dateObject).utcOffset(-currentTimezone).utcOffset(this.displayTimezone).toDate();
            this.$.timePicker.hour = moment(this.$.datePicker.date).format("HH");
            this.$.timePicker.minute = moment(this.$.datePicker.date).format("mm");
          }
        }

        if (this.readonly != null && !this.readonly) {
          this.$.dialog.toggle();
        }
      },

      closeDialogHandler: function(event) {
        if (event.detail.confirmed) {
          var currentTimezone = moment(new Date()).utcOffset();

          if (this.$.datePicker.date == null)
            this.$.datePicker.date = new Date();

          if (this.$.timePicker.hour == null)
            this.$.timePicker.hour = moment(this.$.datePicker.date).format("HH");
          if (this.$.timePicker.minute == null)
            this.$.timePicker.minute = moment(this.$.datePicker.date).format("mm");

          var tmpDate = new Date(moment(this.$.datePicker.date).format("YYYY"),moment(this.$.datePicker.date).format("MM"),moment(this.$.datePicker.date).format("DD"),this.$.timePicker.hour,this.$.timePicker.minute,moment(this.$.datePicker.date).format("ss"),moment(this.$.datePicker.date).format("SSS"));

          var displayDate = moment(tmpDate).utcOffset(-currentTimezone).utcOffset(this.displayTimezone).format(this.displayDateFormat);

          var storeDate = moment(tmpDate).utcOffset(-currentTimezone).utcOffset(this.storeTimezone).format(this.storeDateFormat);

          this.set("value", storeDate);
          this.set("displayValue", displayDate);
        }
      },

      _valueChanged: function(value){
        // Check valid
        if(value != null){
          var reg = new RegExp(this.pattern, 'g');
          this.hasErrors = !reg.test(value);

          var currentTimezone = moment(new Date()).utcOffset();
          this.set("displayValue", moment(value,this.storeDateFormat).utcOffset(-currentTimezone).utcOffset(this.displayTimezone).format(this.displayDateFormat));
        }
      }


    });
  </script>
</dom-module>